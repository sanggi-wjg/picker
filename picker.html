<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶”ì²¨ í”„ë¡œê·¸ë¨</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --danger-color: #e74c3c;
            --text-color: #333;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* ìƒë‹¨ í—¤ë” & REC í‘œì‹œ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .rec-indicator {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--danger-color);
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .rec-indicator:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .rec-indicator.inactive {
            color: #95a5a6;
        }

        .rec-indicator.inactive .rec-dot {
            background-color: #95a5a6;
            animation: none;
        }

        .rec-dot {
            width: 10px;
            height: 10px;
            background-color: var(--danger-color);
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }

        .current-time {
            font-variant-numeric: tabular-nums;
            font-size: 1.1em;
        }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            flex: 1;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        /* ì¢Œì¸¡: ì„¤ì • ë° ì •ë³´ */
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--bg-color);
            padding-bottom: 10px;
        }

        .data-info {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .data-info p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .hash-box {
            background: #eee;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            color: #555;
            margin-top: 5px;
        }

        .control-group {
            margin-top: auto;
        }

        button {
            width: 100%;
            padding: 15px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }

        .download-btn {
            margin-top: 10px;
            background: #27ae60;
        }

        .download-btn:hover {
            background: #229954;
        }

        .download-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .download-video-btn {
            background: #8e44ad;
        }

        .download-video-btn:hover {
            background: #7d3c98;
        }

        .download-video-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .file-upload {
            margin-bottom: 15px;
        }

        /* ìš°ì¸¡: ì¶”ì²¨ í™”ë©´ */
        .display-area {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            position: relative;
            overflow: hidden;
        }

        /* í›„ë³´ì ë°°ê²½ ë¡¤ë§ íš¨ê³¼ - ì œê±°ë¨ */

        .draw-status {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .slot-machine {
            display: flex;
            gap: 40px;
            width: 100%;
            justify-content: center;
            position: relative;
            z-index: 2;
            padding: 0 20px;
        }

        .winner-card {
            background: white;
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            width: 45%;
            max-width: 500px;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .winner-card.active {
            transform: scale(1.0);
            border-color: #27ae60;
            background: linear-gradient(135deg, #f0fff4 0%, #e8f8f5 100%);
            box-shadow: 0 0 30px rgba(39, 174, 96, 0.5), 0 15px 40px rgba(0,0,0,0.2);
            animation: winnerReveal 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes winnerReveal {
            0% {
                transform: scale(0.8) rotateY(-10deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.05) rotateY(5deg);
            }
            100% {
                transform: scale(1.0) rotateY(0deg);
                opacity: 1;
            }
        }

        .winner-sub {
            font-size: 16px;
            color: #7f8c8d;
            margin-top: 5px;
            font-weight: normal;
        }

        /* ìŠ¬ë¡¯ ë¨¸ì‹  êµ¬ì¡° */
        .slot-window {
            position: relative;
            width: 100%;
            height: 100px;
            overflow: hidden;
            margin: 10px 0;
        }

        .slot-reel {
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            will-change: transform, filter;
            transform: translateZ(0); /* GPU acceleration */
        }

        .slot-item {
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
        }

        .slot-item-sub {
            font-size: 18px;
            color: #7f8c8d;
            margin-top: 5px;
            font-weight: normal;
        }

        /* ìŠ¬ë¡¯ ì •ì§€ ì‹œ ë°”ìš´ìŠ¤ íš¨ê³¼ */
        @keyframes slotStop {
            0% { transform: translateY(-15px); }
            50% { transform: translateY(8px); }
            100% { transform: translateY(0); }
        }

        /* ë‹¹ì²¨ì ê¸€ë¡œìš° íš¨ê³¼ */
        @keyframes winnerGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(39, 174, 96, 0.3),
                            0 15px 40px rgba(0,0,0,0.2);
            }
            50% {
                box-shadow: 0 0 40px rgba(39, 174, 96, 0.8),
                            0 0 60px rgba(39, 174, 96, 0.4),
                            0 15px 40px rgba(0,0,0,0.2);
            }
        }

        /* ë‹¹ì²¨ ì¹´ë“œì— ê¸€ë¡œìš° ì• ë‹ˆë©”ì´ì…˜ ì ìš© */
        .winner-card.active {
            animation: winnerReveal 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                       winnerGlow 2s ease-in-out infinite 0.8s;
        }

        /* í•˜ë‹¨: ë¡œê·¸ */
        footer {
            height: 400px;
            margin-top: 20px;
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .log-entry { margin: 4px 0; }
        .log-time { color: #888; margin-right: 10px; }
        .legal-notice {
            text-align: center;
            font-size: 11px;
            color: #666;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <header>
        <div style="font-size: 20px; font-weight: bold;">ì¶”ì²¨ í”„ë¡œê·¸ë¨ v1.0</div>
        <div style="display:flex; align-items:center; gap:20px;">
            <div class="current-time" id="clock">00:00:00</div>
            <div class="rec-indicator inactive" id="rec-indicator" onclick="toggleRecording()" title="í´ë¦­í•˜ì—¬ í™”ë©´ ë…¹í™” ì‹œì‘/ì¤‘ì§€">
                <div class="rec-dot"></div> <span id="rec-status">ë…¹í™” ëŒ€ê¸°</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="panel-title">ë°ì´í„° ë° ì„¤ì •</div>
            
            <div class="file-upload">
                <label style="display:block; margin-bottom:8px; font-size:14px; font-weight:bold;">ë°ì´í„° íŒŒì¼ ë¡œë“œ</label>
                <input type="file" id="fileInput" accept=".csv" onchange="loadCSVFile(event)" style="width:100%; padding:8px; margin-bottom:10px; border:2px dashed #3498db; border-radius:6px; background:#f8f9fa; cursor:pointer;">
            </div>

            <div class="data-info">
                <p>ì´ ëŒ€ìƒì: <strong id="total-count">- ëª…</strong></p>
                <p>ì¶”ì²¨ ì¸ì›: <strong>2 ëª…</strong></p>
                <p>ì•Œê³ ë¦¬ì¦˜: <span>Crypto Secure Random</span></p>
                <div style="margin-top:15px; font-size:12px; font-weight:bold;">ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ (SHA-256):</div>
                <div class="hash-box" id="data-hash">ë°ì´í„° ëŒ€ê¸° ì¤‘...</div>
            </div>

            <div class="control-group">
                <button id="start-btn" onclick="startDrawWithRecording()" disabled>ì¶”ì²¨ ì‹œì‘</button>
                <button id="download-btn" class="download-btn" onclick="downloadResults()" disabled>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                <button id="download-video-btn" class="download-btn download-video-btn" onclick="downloadRecording()" disabled>ë…¹í™”ë³¸ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <div class="card display-area">
            <div class="draw-status" id="status-text">ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.</div>

            <div class="slot-machine">
                <div class="winner-card" id="card-1">
                    <div class="slot-window" id="slot-window-1">
                        <div class="slot-reel" id="slot-reel-1">
                            <div class="slot-item">?</div>
                        </div>
                    </div>
                    <div class="winner-sub" id="extra-info-1">-</div>
                </div>
                <div class="winner-card" id="card-2">
                    <div class="slot-window" id="slot-window-2">
                        <div class="slot-reel" id="slot-reel-2">
                            <div class="slot-item">?</div>
                        </div>
                    </div>
                    <div class="winner-sub" id="extra-info-2">-</div>
                </div>
            </div>
        </div>
    </div>

    <footer id="log-console">
        <div class="log-entry">> ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ.</div>
        <div class="log-entry">> ì¶”ì²¨ ê³¼ì •ì€ ë…¹í™”ë˜ì–´ ë³´ê´€ë˜ë©° ë²•ì  íš¨ë ¥ì„ ê°€ì§‘ë‹ˆë‹¤.</div>
    </footer>

    <div class="legal-notice">
        ë³¸ ì¶”ì²¨ì€ ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜ ìƒì„±ê¸°(CSPRNG)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µì •í•˜ê²Œ ì§„í–‰ë©ë‹ˆë‹¤. 
        ê²°ê³¼ëŠ” ì¡°ì‘ë  ìˆ˜ ì—†ìœ¼ë©° í•´ì‹œê°’ì„ í†µí•´ ë°ì´í„° ë¬´ê²°ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let candidates = [];
        let isDrawing = false;
        let drawResults = null; // ì¶”ì²¨ ê²°ê³¼ ì €ì¥
        let drawTimestamp = null; // ì¶”ì²¨ ì‹œê°„ ì €ì¥
        let dataHash = null; // ë°ì´í„° í•´ì‹œ ì €ì¥
        let drawLogs = []; // ì¶”ì²¨ ë¡œê·¸ ì €ì¥

        // ë…¹í™” ê´€ë ¨ ë³€ìˆ˜
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let recordingStream = null;
        
        // 1. ì‹œê³„ ê¸°ëŠ¥
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleString('ko-KR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. ë¡œê·¸ ê¸°ëŠ¥
        function addLog(msg) {
            const consoleBox = document.getElementById('log-console');
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0];
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">[${timeStr}]</span> ${msg}`;
            consoleBox.appendChild(div);
            consoleBox.scrollTop = consoleBox.scrollHeight;

            // ë¡œê·¸ë¥¼ ë°°ì—´ì—ë„ ì €ì¥ (ë‹¤ìš´ë¡œë“œìš©)
            drawLogs.push({
                timestamp: timeStr,
                message: msg
            });
        }

        // 3. ë°ì´í„° ë§ˆìŠ¤í‚¹ (ê°œì¸ì •ë³´ ë³´í˜¸)
        function maskName(name) {
            if (!name) return "";
            if (name.length <= 2) return name[0] + '*';
            return name[0] + '*'.repeat(name.length - 2) + name[name.length - 1];
        }

        function maskId(id) {
            if (!id) return "";
            if (id.length === 1) return '*';
            if (id.length === 2) return id[0] + '*';
            // 3ìë¦¬ ì´ìƒ: ë§ˆì§€ë§‰ 3ìë¦¬ë§Œ ë§ˆìŠ¤í‚¹
            return id.substring(0, id.length - 3) + '***';
        }

        function maskMobile(mobile) {
            if (!mobile) return "";
            // ì „í™”ë²ˆí˜¸ í˜•ì‹: 010-1234-5678 -> 010-****-5678
            // ë˜ëŠ” 01012345678 -> 010****5678
            const cleaned = mobile.replace(/[^0-9]/g, '');
            if (cleaned.length < 9) return '***-****-***';

            const first = cleaned.substring(0, 3);
            const last = cleaned.substring(cleaned.length - 4);
            return `${first}-****-${last}`;
        }

        // 4. CSV íŒŒì¼ ë¡œë“œ ë° íŒŒì‹±
        async function loadCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            addLog(`íŒŒì¼ ë¡œë“œ ì‹œì‘: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);

            try {
                const text = await file.text();
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);

                if (lines.length === 0) {
                    throw new Error("ë¹ˆ íŒŒì¼ì…ë‹ˆë‹¤.");
                }

                candidates = [];

                // ì²« ë²ˆì§¸ ì¤„ì´ í—¤ë”ì¸ì§€ í™•ì¸ (ì´ë¦„, ë²ˆí˜¸ ë“±ì˜ í‚¤ì›Œë“œ í¬í•¨)
                const firstLine = lines[0].toLowerCase();
                const hasHeader = firstLine.includes('id') && firstLine.includes('name') && firstLine.includes('mobilenumber');
                if (!hasHeader){
                    throw new Error("csv í—¤ë” í¬ë§·ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
                }

                const startIdx = hasHeader ? 1 : 0;
                addLog(`í—¤ë” ê°ì§€: ${hasHeader ? 'ìˆìŒ' : 'ì—†ìŒ'}`);

                // CSV íŒŒì‹±
                for (let i = startIdx; i < lines.length; i++) {
                    const line = lines[i];
                    // ì‰¼í‘œë¡œ ë¶„ë¦¬ (ë”°ì˜´í‘œ ì•ˆì˜ ì‰¼í‘œëŠ” ë¬´ì‹œ)
                    const values = line.split(',').map(v => v.trim().replace(/^["']|["']$/g, ''));

                    if (values.length < 2) {
                        addLog(`âš ï¸ ${i + 1}ë²ˆì§¸ ì¤„ ê±´ë„ˆëœ€: ë°ì´í„° ë¶€ì¡± (${line})`);
                        continue;
                    }

                    candidates.push({
                        id: values[0],
                        name: values[1],
                        mobileNumber: values[2],
                    });
                }

                if (candidates.length === 0) {
                    throw new Error("ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('total-count').innerText = `${candidates.length.toLocaleString()} ëª…`;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('status-text').innerText = "ì¶”ì²¨ ì¤€ë¹„ ì™„ë£Œ";

                addLog(`âœ“ ì´ ${candidates.length}ëª… ë°ì´í„° ë¡œë“œ ì™„ë£Œ.`);

                // ë°ì´í„° ë¬´ê²°ì„± í•´ì‹œ ìƒì„±
                const dataString = JSON.stringify(candidates);
                const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(dataString));
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                document.getElementById('data-hash').innerText = hashHex;
                dataHash = hashHex; // í•´ì‹œ ì €ì¥
                addLog(`ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ì™„ë£Œ. Hash: ${hashHex.substring(0, 20)}...`);

                // CSV íŒŒì¼ ë‚´ìš© ë§ˆìŠ¤í‚¹ ì¶œë ¥
                addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addLog('ğŸ“‹ CSV íŒŒì¼ ë‚´ìš©');
                addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                candidates.forEach((candidate, idx) => {
                    const maskedId = maskId(candidate.id);
                    const maskedName = maskName(candidate.name);
                    const maskedMobile = maskMobile(candidate.mobileNumber);
                    addLog(`${String(idx + 1).padStart(3, ' ')}. ID: ${maskedId.padEnd(10)} | ì´ë¦„: ${maskedName.padEnd(5)} | ì „í™”ë²ˆí˜¸: ${maskedMobile}`);
                });
                addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            } catch (error) {
                addLog(`âŒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                alert(`íŒŒì¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}\n\nCSV í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            }
        }

        // 5. ê³µì •í•œ ì¶”ì²¨ ë¡œì§ (CSPRNG ì‚¬ìš©)
        function getSecureRandomIndex(max) {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] % max;
        }

        // 6. ìŠ¬ë¡¯ ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬
        class SlotMachineController {
            constructor(cardNumber, candidates, winner) {
                this.cardNumber = cardNumber;
                this.candidates = candidates;
                this.winner = winner;
                this.reelEl = document.getElementById(`slot-reel-${cardNumber}`);
                this.windowEl = document.getElementById(`slot-window-${cardNumber}`);

                // ì• ë‹ˆë©”ì´ì…˜ íŒŒë¼ë¯¸í„°
                this.ITEM_HEIGHT = 100;
                this.FAST_DURATION = 1500; // 1.5ì´ˆ ë¹ ë¥¸ ë¡¤ë§
                this.SLOW_DURATION = 1500; // 1.5ì´ˆ ê°ì†
                this.TOTAL_DURATION = this.FAST_DURATION + this.SLOW_DURATION;

                this.startTime = null;
                this.animationFrame = null;
                this.onComplete = null;
            }

            // ì´ë¦„ í’€ ìƒì„± (ë‹¹ì²¨ìë¥¼ ê³„ì‚°ëœ ìœ„ì¹˜ì— ì‚½ì…)
            generateNamePool() {
                const poolSize = 25;
                const shuffled = [...this.candidates].sort(() => Math.random() - 0.5);
                const pool = shuffled.slice(0, poolSize);

                // ë‹¹ì²¨ìë¥¼ 75% ìœ„ì¹˜ì— ì‚½ì…
                const winnerIndex = Math.floor(poolSize * 0.75);
                pool[winnerIndex] = this.winner;

                return pool;
            }

            // ë¦´ì— ì´ë¦„ ì•„ì´í…œ ì±„ìš°ê¸°
            populateReel() {
                const pool = this.generateNamePool();
                this.reelEl.innerHTML = '';

                pool.forEach((candidate) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'slot-item';

                    const nameDiv = document.createElement('div');
                    nameDiv.textContent = maskName(candidate.name);

                    const subDiv = document.createElement('div');
                    subDiv.className = 'slot-item-sub';
                    subDiv.textContent = maskId(candidate.id);

                    itemDiv.appendChild(nameDiv);
                    itemDiv.appendChild(subDiv);
                    this.reelEl.appendChild(itemDiv);
                });

                this.totalItems = pool.length;
                this.winnerIndex = Math.floor(this.totalItems * 0.75);
            }

            // ì‹œê°„ì— ë”°ë¥¸ ìœ„ì¹˜ ê³„ì‚°
            calculatePosition(elapsed) {
                if (elapsed < this.FAST_DURATION) {
                    // Phase 1: ë¹ ë¥¸ ì¼ì • ì†ë„
                    const progress = elapsed / this.FAST_DURATION;
                    const distance = progress * (this.totalItems * this.ITEM_HEIGHT * 0.5);
                    return -distance;
                } else {
                    // Phase 2: ê°ì†
                    const slowElapsed = elapsed - this.FAST_DURATION;
                    const slowProgress = slowElapsed / this.SLOW_DURATION;

                    // Ease-out-cubicìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ ê°ì†
                    const easedProgress = 1 - Math.pow(1 - slowProgress, 3);

                    const fastDistance = this.totalItems * this.ITEM_HEIGHT * 0.5;
                    const slowDistance = (this.totalItems * this.ITEM_HEIGHT * 0.25) * easedProgress;

                    return -(fastDistance + slowDistance);
                }
            }

            // ì†ë„ì— ë”°ë¥¸ ë¸”ëŸ¬ ì–‘ ê³„ì‚°
            calculateBlur(elapsed) {
                if (elapsed < this.FAST_DURATION) {
                    return 1.5; // ì „ì²´ ë¸”ëŸ¬ (3px â†’ 1.5pxë¡œ ê°ì†Œ)
                } else {
                    const slowElapsed = elapsed - this.FAST_DURATION;
                    const slowProgress = slowElapsed / this.SLOW_DURATION;
                    return 1.5 * (1 - slowProgress); // ë¸”ëŸ¬ í˜ì´ë“œ 1.5px â†’ 0px
                }
            }

            // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
            animate(timestamp) {
                if (!this.startTime) this.startTime = timestamp;
                const elapsed = timestamp - this.startTime;

                if (elapsed < this.TOTAL_DURATION) {
                    const position = this.calculatePosition(elapsed);
                    const blur = this.calculateBlur(elapsed);

                    this.reelEl.style.transform = `translateY(${position}px)`;
                    this.reelEl.style.filter = `blur(${blur}px)`;

                    this.animationFrame = requestAnimationFrame((t) => this.animate(t));
                } else {
                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ - ìµœì¢… ìœ„ì¹˜ë¡œ ìŠ¤ëƒ…
                    this.finalize();
                }
            }

            // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
            finalize() {
                // ìµœì¢… ìœ„ì¹˜ ê³„ì‚° (ë‹¹ì²¨ì ì¤‘ì•™)
                const finalPosition = -(this.winnerIndex * this.ITEM_HEIGHT);

                this.reelEl.style.transform = `translateY(${finalPosition}px)`;
                this.reelEl.style.filter = 'blur(0px)';
                this.reelEl.style.transition = 'transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

                // ë‹¹ì²¨ì ê³µê°œ íš¨ê³¼ íŠ¸ë¦¬ê±°
                setTimeout(() => {
                    const cardEl = document.getElementById(`card-${this.cardNumber}`);
                    cardEl.classList.add('active');

                    // ì¶”ê°€ ì •ë³´ í‘œì‹œ
                    const extraInfo = document.getElementById(`extra-info-${this.cardNumber}`);
                    extraInfo.textContent = maskMobile(this.winner.mobileNumber);

                    if (this.onComplete) this.onComplete();
                }, 300);
            }

            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            start() {
                this.populateReel();
                this.animationFrame = requestAnimationFrame((t) => this.animate(t));
                return this;
            }

            // ì •ë¦¬
            stop() {
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
            }
        }

        // 7. ì¶”ì²¨ ì‹œì‘ (ìŠ¬ë¡¯ ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜)
        function startDraw() {
            if (isDrawing) return;
            if (candidates.length === 0) {
                alert("ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            isDrawing = true;
            drawTimestamp = new Date(); // ì¶”ì²¨ ì‹œì‘ ì‹œê°„ ê¸°ë¡
            drawResults = null; // ê²°ê³¼ ì´ˆê¸°í™”
            document.getElementById('start-btn').disabled = true;
            document.getElementById('download-btn').disabled = true; // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('status-text').innerText = "ì¶”ì²¨ ì§„í–‰ ì¤‘...";
            document.getElementById('status-text').style.color = "#333";
            addLog("ì¶”ì²¨ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (Algorithm: CSPRNG)");

            // ì¹´ë“œ ìƒíƒœ ì´ˆê¸°í™”
            document.getElementById('card-1').classList.remove('active');
            document.getElementById('card-2').classList.remove('active');

            // CSPRNGë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¹ì²¨ì ì„ ì •
            const winnerIdx1 = getSecureRandomIndex(candidates.length);
            let winnerIdx2 = getSecureRandomIndex(candidates.length);
            while(winnerIdx1 === winnerIdx2) {
                winnerIdx2 = getSecureRandomIndex(candidates.length);
            }

            const winner1 = candidates[winnerIdx1];
            const winner2 = candidates[winnerIdx2];

            // ê²°ê³¼ ì €ì¥
            drawResults = {
                winner1: winner1,
                winner2: winner2,
                timestamp: drawTimestamp,
                totalCandidates: candidates.length
            };

            addLog(`ë³´ì•ˆ ë‚œìˆ˜ ìƒì„±`);

            // ìŠ¬ë¡¯ ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜ ìˆœì°¨ ì‹œì‘
            animateSlotMachines(winner1, winner2);
        }

        function animateSlotMachines(winner1, winner2) {
            const statusEl = document.getElementById('status-text');

            // ì¹´ë“œ 1 ì• ë‹ˆë©”ì´ì…˜
            statusEl.innerText = "ğŸ° 1ë²ˆ ë‹¹ì²¨ì ì¶”ì²¨ ì¤‘...";
            statusEl.style.color = "#e67e22";

            const slot1 = new SlotMachineController(1, candidates, winner1);

            slot1.onComplete = () => {
                addLog(`[ê²°ê³¼ í™•ì •] 1ë²ˆ ë‹¹ì²¨ì: ${maskName(winner1.name)} / ${maskId(winner1.id)} / ${maskMobile(winner1.mobileNumber)}`);

                // 800ms ëŒ€ê¸° í›„ ì¹´ë“œ 2 ì‹œì‘
                setTimeout(() => {
                    statusEl.innerText = "ğŸ° 2ë²ˆ ë‹¹ì²¨ì ì¶”ì²¨ ì¤‘...";

                    const slot2 = new SlotMachineController(2, candidates, winner2);

                    slot2.onComplete = () => {
                        addLog(`[ê²°ê³¼ í™•ì •] 2ë²ˆ ë‹¹ì²¨ì: ${maskName(winner2.name)} / ${maskId(winner2.id)} / ${maskMobile(winner2.mobileNumber)}`);

                        // ìµœì¢… ì¶•í•˜ ë©”ì‹œì§€
                        setTimeout(() => {
                            statusEl.innerText = "ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ë‹¹ì²¨ìê°€ ì„ ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŠ";
                            statusEl.style.color = "#27ae60";
                            statusEl.style.fontWeight = "bold";
                            addLog("ì¶”ì²¨ ì¢…ë£Œ. ê²°ê³¼ ë°ì´í„° ì €ì¥ ì™„ë£Œ.");
                            isDrawing = false;
                            document.getElementById('start-btn').disabled = true;
                            document.getElementById('download-btn').disabled = false; // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                        }, 1000);
                    };

                    slot2.start();
                }, 800);
            };

            slot1.start();
        }

        // 8. ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        function downloadResults() {
            if (!drawResults) {
                alert("ì¶”ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¶”ì²¨ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ë‹¤ìš´ë¡œë“œí•  ë°ì´í„° ìƒì„±
            const downloadData = {
                title: "ì¶”ì²¨ ê²°ê³¼ ë³´ê³ ì„œ",
                drawInfo: {
                    timestamp: drawResults.timestamp.toLocaleString('ko-KR'),
                    totalCandidates: drawResults.totalCandidates,
                    drawCount: 2,
                    algorithm: "CSPRNG (Cryptographically Secure Pseudo-Random Number Generator)"
                },
                dataIntegrity: {
                    hashAlgorithm: "SHA-256",
                    dataHash: dataHash
                },
                winners: [
                    {
                        position: "1ë²ˆ ë‹¹ì²¨ì",
                        id: drawResults.winner1.id,
                        name: drawResults.winner1.name,
                        mobileNumber: drawResults.winner1.mobileNumber
                    },
                    {
                        position: "2ë²ˆ ë‹¹ì²¨ì",
                        id: drawResults.winner2.id,
                        name: drawResults.winner2.name,
                        mobileNumber: drawResults.winner2.mobileNumber
                    }
                ],
                logs: drawLogs
            };

            // JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            downloadJSON(downloadData);
            addLog("ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ.");
        }

        // JSON í˜•ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
        function downloadJSON(data) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì¶”ì²¨ê²°ê³¼_${formatDateForFilename(drawResults.timestamp)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // íŒŒì¼ëª…ìš© ë‚ ì§œ í¬ë§·
        function formatDateForFilename(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}_${hour}${minute}${second}`;
        }

        // 9. í™”ë©´ ë…¹í™” ê¸°ëŠ¥
        async function startRecording() {
            try {
                // í™”ë©´ ìº¡ì²˜ ìš”ì²­
                recordingStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        mediaSource: 'screen',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                });

                // MediaRecorder ìƒì„±
                const options = { mimeType: 'video/webm; codecs=vp9' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }

                mediaRecorder = new MediaRecorder(recordingStream, options);
                recordedChunks = [];

                // ë°ì´í„° ìˆ˜ì‹  ì´ë²¤íŠ¸
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                // ë…¹í™” ì¢…ë£Œ ì´ë²¤íŠ¸
                mediaRecorder.onstop = () => {
                    addLog('ë…¹í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë…¹í™”ë³¸ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    document.getElementById('download-video-btn').disabled = false;
                };

                // ë…¹í™” ì‹œì‘
                mediaRecorder.start(1000); // 1ì´ˆë§ˆë‹¤ ë°ì´í„° ìˆ˜ì§‘
                isRecording = true;

                // UI ì—…ë°ì´íŠ¸
                updateRecordingUI();
                addLog('í™”ë©´ ë…¹í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ì‚¬ìš©ìê°€ í™”ë©´ ê³µìœ ë¥¼ ì¤‘ì§€í•˜ë©´ ë…¹í™”ë„ ì¤‘ì§€
                recordingStream.getVideoTracks()[0].onended = () => {
                    if (isRecording) {
                        stopRecording();
                    }
                };

            } catch (error) {
                console.error('ë…¹í™” ì‹œì‘ ì‹¤íŒ¨:', error);
                addLog(`âŒ ë…¹í™” ì‹œì‘ ì‹¤íŒ¨: ${error.message}`);
                alert('í™”ë©´ ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì €ì—ì„œ í™”ë©´ ê³µìœ  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;

                // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                if (recordingStream) {
                    recordingStream.getTracks().forEach(track => track.stop());
                    recordingStream = null;
                }

                updateRecordingUI();
                addLog('ë…¹í™”ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        function updateRecordingUI() {
            const indicator = document.getElementById('rec-indicator');
            const statusText = document.getElementById('rec-status');

            if (isRecording) {
                indicator.classList.remove('inactive');
                statusText.textContent = 'REC ë…¹í™” ì¤‘';
            } else {
                indicator.classList.add('inactive');
                statusText.textContent = 'ë…¹í™” ëŒ€ê¸°';
            }
        }

        function downloadRecording() {
            if (recordedChunks.length === 0) {
                alert('ë…¹í™”ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Blob ìƒì„±
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);

            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì¶”ì²¨ë…¹í™”_${formatDateForFilename(new Date())}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // URL í•´ì œ
            setTimeout(() => URL.revokeObjectURL(url), 100);

            addLog('ë…¹í™” ì˜ìƒì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
        }

        // 10. ì¶”ì²¨ ì‹œì‘ ì‹œ ìë™ ë…¹í™”
        async function startDrawWithRecording() {
            // ë…¹í™”ê°€ ë˜ì§€ ì•Šê³  ìˆë‹¤ë©´ ìë™ìœ¼ë¡œ ì‹œì‘
            if (!isRecording) {              
                alert("ë…¹í™”ë¥¼ ë¨¼ì € ì‹œì‘í•´ì£¼ì„¸ìš”.")
                return
                // addLog('ì¶”ì²¨ê³¼ í•¨ê»˜ ìë™ìœ¼ë¡œ ë…¹í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                // await startRecording();

                // // ë…¹í™”ê°€ ì‹œì‘ë  ì‹œê°„ ëŒ€ê¸° (500ms)
                // await new Promise(resolve => setTimeout(resolve, 500));
            }

            // ê¸°ì¡´ ì¶”ì²¨ ë¡œì§ ì‹¤í–‰
            startDraw();
        }
    </script>
</body>
</html>